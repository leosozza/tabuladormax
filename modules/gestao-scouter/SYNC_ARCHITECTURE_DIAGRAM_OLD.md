# Arquitetura de Sincronizaรงรฃo: Leads โ Fichas

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                      PROJETO TABULADORMAX                                    โ
โ                    (gkvvtfqfggddzotxltxf)                                   โ
โ                                                                              โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ  โ                      Tabela: leads                                  โ    โ
โ  โ  - id, nome, telefone, email, idade                                โ    โ
โ  โ  - projeto, scouter, supervisor                                    โ    โ
โ  โ  - localizacao, latitude, longitude                                โ    โ
โ  โ  - criado, valor_ficha, etapa                                      โ    โ
โ  โ  - ficha_confirmada, foto, etc.                                    โ    โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ                              โ โ โ                                          โ
โ                     TRIGGERS (Tempo Real)                                   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ  โ  โข trigger_sync_lead_insert  (AFTER INSERT)                       โ      โ
โ  โ  โข trigger_sync_lead_update  (AFTER UPDATE)                       โ      โ
โ  โ  โข trigger_sync_lead_delete  (AFTER DELETE)                       โ      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ                              โ                                              โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ  โ         Funรงรฃo: sync_lead_to_fichas()                             โ      โ
โ  โ  1. Captura operaรงรฃo (INSERT/UPDATE/DELETE)                       โ      โ
โ  โ  2. Monta payload JSON com todos os campos                        โ      โ
โ  โ  3. Faz HTTP POST/DELETE para Gestรฃo Scouter                      โ      โ
โ  โ  4. Loga resultado (success/warning)                              โ      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                    โ
                          HTTP Request (REST API)
                          POST /rest/v1/fichas
                          DELETE /rest/v1/fichas?id=eq.XXX
                                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                   PROJETO GESTรO SCOUTER                                     โ
โ                   (ngestyxtopvfeyenyvgt)                                    โ
โ                                                                              โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ  โ            Supabase REST API (Service Role)                        โ    โ
โ  โ  โข Recebe upsert/delete via HTTP                                   โ    โ
โ  โ  โข Valida autenticaรงรฃo (service role key)                          โ    โ
โ  โ  โข Aplica RLS policies                                             โ    โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ                              โ                                              โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ  โ                      Tabela: fichas                                 โ    โ
โ  โ  - id (PK), nome, telefone, email, idade                           โ    โ
โ  โ  - projeto, scouter, supervisor                                    โ    โ
โ  โ  - localizacao, latitude, longitude                                โ    โ
โ  โ  - criado, valor_ficha, etapa                                      โ    โ
โ  โ  - ficha_confirmada, foto                                          โ    โ
โ  โ  - raw (jsonb) - backup completo                                   โ    โ
โ  โ  - updated_at, deleted                                             โ    โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ                              โ                                              โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ  โ                  Dashboard Analytics                                โ    โ
โ  โ  โข Performance por scouter                                         โ    โ
โ  โ  โข Relatรณrios e mรฉtricas                                           โ    โ
โ  โ  โข Mapas de calor                                                  โ    โ
โ  โ  โข Sistema IQS                                                     โ    โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                        MIGRAรรO INICIAL (Uma vez)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    Script: syncLeadsToFichas.ts                              โ
โ                                                                              โ
โ  FLUXO DE EXECUรรO:                                                          โ
โ  1. โ Validar configuraรงรฃo (.env)                                          โ
โ  2. โ Conectar aos dois projetos Supabase                                  โ
โ  3. โ Buscar todos os leads (paginaรงรฃo automรกtica)                         โ
โ  4. โ Processar em lotes de 1000 registros                                 โ
โ  5. โ Normalizar dados (datas, tipos)                                      โ
โ  6. โ Fazer upsert na tabela fichas                                        โ
โ  7. โ Retry automรกtico em caso de erro (3x)                                โ
โ  8. โ Gerar relatรณrio final                                                โ
โ                                                                              โ
โ  PERFORMANCE ESPERADA:                                                       โ
โ  โข 200k registros em ~80-100 segundos                                       โ
โ  โข Taxa: 2000-3000 registros/segundo                                        โ
โ  โข Taxa de sucesso: > 99.9%                                                 โ
โ                                                                              โ
โ  COMANDO:                                                                    โ
โ  $ npm run migrate:leads                                                    โ
โ  ou                                                                          โ
โ  $ npx tsx scripts/syncLeadsToFichas.ts                                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                               CARACTERรSTICAS
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ      TRIGGERS SQL        โ               SCRIPT MIGRAรรO                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ โ Tempo real (< 100ms)  โ โ Migraรงรฃo inicial completa                    โ
โ โ Automรกtico             โ โ Processamento em lotes                       โ
โ โ INSERT/UPDATE/DELETE   โ โ Normalizaรงรฃo de dados                        โ
โ โ Sem polling            โ โ Progress tracking                            โ
โ โ HTTP-based             โ โ Retry automรกtico                             โ
โ โ Logs integrados        โ โ Relatรณrio detalhado                          โ
โ โ๏ธ  Requer HTTP extensionโ โ๏ธ  Execuรงรฃo manual                             โ
โ โ๏ธ  Cross-database        โ โ๏ธ  Uma vez apenas                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโดโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                          MAPEAMENTO DE CAMPOS
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

leads (origem)              โ    fichas (destino)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
id                          โ    id (string)
nome                        โ    nome
telefone                    โ    telefone  
email                       โ    email
idade                       โ    idade (string)
projeto                     โ    projeto
scouter                     โ    scouter
supervisor                  โ    supervisor
localizacao                 โ    localizacao
latitude                    โ    latitude
longitude                   โ    longitude
local_da_abordagem          โ    local_da_abordagem
criado                      โ    criado (YYYY-MM-DD)
valor_ficha                 โ    valor_ficha
etapa                       โ    etapa
ficha_confirmada            โ    ficha_confirmada
foto                        โ    foto
*todos os campos*           โ    raw (jsonb backup)
updated_at                  โ    updated_at
-                           โ    deleted (false)

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            SEGURANรA E AUDITORIA
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

๐ SEGURANรA:
  โข Service role keys em variรกveis de ambiente
  โข .env no .gitignore
  โข RLS policies na tabela fichas
  โข SECURITY DEFINER nas funรงรตes SQL

๐ AUDITORIA:
  โข Campo raw preserva dados originais
  โข Timestamp updated_at para tracking
  โข Logs PostgreSQL para triggers
  โข Logs de aplicaรงรฃo para migration script

โก PERFORMANCE:
  โข Batch processing (1000 registros)
  โข Connection pooling
  โข Retry com backoff exponencial
  โข Progress tracking em tempo real

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```
